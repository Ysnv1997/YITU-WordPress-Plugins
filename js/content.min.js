/*
    Plugin Name: 益图图床外链小工具
    Plugin URI: http://ishanran.com/yitu/
    Description: 山然小站独自开发的图床插件，用于WordPress博客添加 图床上传小工具、评论处图片上传按钮、文章编辑处图片上传按钮。
    Author: 山然小站
    Author URI: http://ishanran.com/
    Version: 1.1
*/
jQuery(document).ready(function($) {
    $('#admin-img-file').change(function() {
        var formData = new FormData();
            for (var i = 0; i < this.files.length; i++) {
                var f = this.files[i];
                formData.append('image', f);
            }
            formData.append('token', infoData.Token);
            formData.append('apiType', 'ali,qpic,baidu');
            $.ajax({
                url: 'https://htm.fun/api/upload',
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData,
                success: function(res) {
                    console.log(res)
                    $('textarea[name="content"]').insertAtCaret('<!-- 本站正在使用益图作为全站图片外链工具，www.htm.fun，永久免费不丢图图床 --> <img class="aligncenter" src="' + res.data.url.distribute + '" />');
                    $("html").find("iframe").contents().find("body").append('<!-- 本站正在使用益图作为全站图片外链工具，www.htm.fun，永久免费不丢图图床 --><img class="aligncenter" src="' + res.data.url.distribute + '" />')
                },
                error:function (e) { 
                    console.log(e)
                 }
            })
        
    });
    $.fn.extend({
        insertAtCaret: function(myValue) {
            var $t = $(this)[0];
            if (document.selection) {
                this.focus();
                sel = document.selection.createRange();
                sel.text = myValue;
                this.focus()
            } else if ($t.selectionStart || $t.selectionStart == "0") {
                var startPos = $t.selectionStart;
                var endPos = $t.selectionEnd;
                var scrollTop = $t.scrollTop;
                $t.value = $t.value.substring(0, startPos) + myValue + $t.value.substring(endPos, $t.value.length);
                this.focus();
                $t.selectionStart = startPos + myValue.length;
                $t.selectionEnd = startPos + myValue.length;
                $t.scrollTop = scrollTop
            } else {
                this.value += myValue;
                this.focus()
            }
        }
    })
})